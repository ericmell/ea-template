org.cometd.Cometd=function(name){var _cometd=this;var _name=name||"default";var _crossDomain=false;var _transports=new org.cometd.TransportRegistry();var _transport;var _status="disconnected";var _messageId=0;var _clientId=null;var _batch=0;var _messageQueue=[];var _internalBatch=false;var _listeners={};var _backoff=0;var _scheduledSend=null;var _extensions=[];var _advice={};var _handshakeProps;var _publishCallbacks={};var _reestablish=false;var _connected=false;var _config={protocol:null,connectTimeout:0,maxConnections:2,backoffIncrement:1000,maxBackoff:60000,logLevel:"info",reverseIncomingExtensions:true,maxNetworkDelay:10000,requestHeaders:{},appendMessageTypeToURL:true,autoBatch:false,advice:{timeout:60000,interval:0,reconnect:"retry"}};function _fieldValue(object,name){try{return object[name]}catch(x){return undefined}}this._mixin=function(deep,target,objects){var result=target||{};for(var i=2;i<arguments.length;++i){var object=arguments[i];if(object===undefined||object===null){continue}for(var propName in object){var prop=_fieldValue(object,propName);var targ=_fieldValue(result,propName);if(prop===target){continue}if(prop===undefined){continue}if(deep&&typeof prop==="object"&&prop!==null){if(prop instanceof Array){result[propName]=this._mixin(deep,targ instanceof Array?targ:[],prop)}else{var source=typeof targ==="object"&&!(targ instanceof Array)?targ:{};result[propName]=this._mixin(deep,source,prop)}}else{result[propName]=prop}}}return result};function _isString(value){return org.cometd.Utils.isString(value)}function _isFunction(value){if(value===undefined||value===null){return false}return typeof value==="function"}function _log(level,args){if(window.console){var logger=window.console[level];if(_isFunction(logger)){logger.apply(window.console,args)}}}this._warn=function(){_log("warn",arguments)};this._info=function(){if(_config.logLevel!=="warn"){_log("info",arguments)}};this._debug=function(){if(_config.logLevel==="debug"){_log("debug",arguments)}};this._isCrossDomain=function(hostAndPort){return hostAndPort&&hostAndPort!==window.location.host};function _configure(configuration){_cometd._debug("Configuring cometd object with",configuration);if(_isString(configuration)){configuration={url:configuration}}if(!configuration){configuration={}}_config=_cometd._mixin(false,_config,configuration);var url=_cometd.getURL();if(!url){throw"Missing required configuration parameter 'url' specifying the Bayeux server URL"}var urlParts=/(^https?:\/\/)?(((\[[^\]]+\])|([^:\/\?#]+))(:(\d+))?)?([^\?#]*)(.*)?/.exec(url);var hostAndPort=urlParts[2];var uri=urlParts[8];var afterURI=urlParts[9];_crossDomain=_cometd._isCrossDomain(hostAndPort);if(_config.appendMessageTypeToURL){if(afterURI!==undefined&&afterURI.length>0){_cometd._info("Appending message type to URI "+uri+afterURI+" is not supported, disabling 'appendMessageTypeToURL' configuration");_config.appendMessageTypeToURL=false}else{var uriSegments=uri.split("/");var lastSegmentIndex=uriSegments.length-1;if(uri.match(/\/$/)){lastSegmentIndex-=1}if(uriSegments[lastSegmentIndex].indexOf(".")>=0){_cometd._info("Appending message type to URI "+uri+" is not supported, disabling 'appendMessageTypeToURL' configuration");_config.appendMessageTypeToURL=false}}}}function _removeListener(subscription){if(subscription){var subscriptions=_listeners[subscription.channel];if(subscriptions&&subscriptions[subscription.id]){delete subscriptions[subscription.id];_cometd._debug("Removed",subscription.listener?"listener":"subscription",subscription)}}}function _removeSubscription(subscription){if(subscription&&!subscription.listener){_removeListener(subscription)}}function _clearSubscriptions(){for(var channel in _listeners){var subscriptions=_listeners[channel];if(subscriptions){for(var i=0;i<subscriptions.length;++i){_removeSubscription(subscriptions[i])}}}}function _setStatus(newStatus){if(_status!==newStatus){_cometd._debug("Status",_status,"->",newStatus);_status=newStatus}}function _isDisconnected(){return _status==="disconnecting"||_status==="disconnected"}function _nextMessageId(){return ++_messageId}function _applyExtension(scope,callback,name,message,outgoing){try{return callback.call(scope,message)}catch(x){_cometd._debug("Exception during execution of extension",name,x);var exceptionCallback=_cometd.onExtensionException;if(_isFunction(exceptionCallback)){_cometd._debug("Invoking extension exception callback",name,x);try{exceptionCallback.call(_cometd,x,name,outgoing,message)}catch(xx){_cometd._info("Exception during execution of exception callback in extension",name,xx)}}return message}}function _applyIncomingExtensions(message){for(var i=0;i<_extensions.length;++i){if(message===undefined||message===null){break}var index=_config.reverseIncomingExtensions?_extensions.length-1-i:i;var extension=_extensions[index];var callback=extension.extension.incoming;if(_isFunction(callback)){var result=_applyExtension(extension.extension,callback,extension.name,message,false);message=result===undefined?message:result}}return message}function _applyOutgoingExtensions(message){for(var i=0;i<_extensions.length;++i){if(message===undefined||message===null){break}var extension=_extensions[i];var callback=extension.extension.outgoing;if(_isFunction(callback)){var result=_applyExtension(extension.extension,callback,extension.name,message,true);message=result===undefined?message:result}}return message}function _notify(channel,message){var subscriptions=_listeners[channel];if(subscriptions&&subscriptions.length>0){for(var i=0;i<subscriptions.length;++i){var subscription=subscriptions[i];if(subscription){try{subscription.callback.call(subscription.scope,message)}catch(x){_cometd._debug("Exception during notification",subscription,message,x);var listenerCallback=_cometd.onListenerException;if(_isFunction(listenerCallback)){_cometd._debug("Invoking listener exception callback",subscription,x);try{listenerCallback.call(_cometd,x,subscription,subscription.listener,message)}catch(xx){_cometd._info("Exception during execution of listener callback",subscription,xx)}}}}}}}function _notifyListeners(channel,message){_notify(channel,message);var channelParts=channel.split("/");var last=channelParts.length-1;for(var i=last;i>0;--i){var channelPart=channelParts.slice(0,i).join("/")+"/*";if(i===last){_notify(channelPart,message)}channelPart+="*";_notify(channelPart,message)}}function _cancelDelayedSend(){if(_scheduledSend!==null){org.cometd.Utils.clearTimeout(_scheduledSend)}_scheduledSend=null}function _delayedSend(operation){_cancelDelayedSend();var delay=_advice.interval+_backoff;_cometd._debug("Function scheduled in",delay,"ms, interval =",_advice.interval,"backoff =",_backoff,operation);_scheduledSend=org.cometd.Utils.setTimeout(_cometd,operation,delay)}var _handleMessages;var _handleFailure;function _send(sync,messages,longpoll,extraPath){for(var i=0;i<messages.length;++i){var message=messages[i];message.id=""+_nextMessageId();if(_clientId){message.clientId=_clientId}var callback=undefined;if(_isFunction(message._callback)){callback=message._callback;delete message._callback}message=_applyOutgoingExtensions(message);if(message!==undefined&&message!==null){messages[i]=message;if(callback){_publishCallbacks[message.id]=callback}}else{messages.splice(i--,1)}}if(messages.length===0){return}var url=_cometd.getURL();if(_config.appendMessageTypeToURL){if(!url.match(/\/$/)){url=url+"/"}if(extraPath){url=url+extraPath}}var envelope={url:url,sync:sync,messages:messages,onSuccess:function(rcvdMessages){try{_handleMessages.call(_cometd,rcvdMessages)}catch(x){_cometd._debug("Exception during handling of messages",x)}},onFailure:function(conduit,messages,failure){try{failure.connectionType=_cometd.getTransport().getType();_handleFailure.call(_cometd,conduit,messages,failure)}catch(x){_cometd._debug("Exception during handling of failure",x)}}};_cometd._debug("Send",envelope);_transport.send(envelope,longpoll)}function _queueSend(message){if(_batch>0||_internalBatch===true){_messageQueue.push(message)}else{_send(false,[message],false)}}this.send=_queueSend;function _resetBackoff(){_backoff=0}function _increaseBackoff(){if(_backoff<_config.maxBackoff){_backoff+=_config.backoffIncrement}}function _startBatch(){++_batch}function _flushBatch(){var messages=_messageQueue;_messageQueue=[];if(messages.length>0){_send(false,messages,false)}}function _endBatch(){--_batch;if(_batch<0){throw"Calls to startBatch() and endBatch() are not paired"}if(_batch===0&&!_isDisconnected()&&!_internalBatch){_flushBatch()}}function _connect(){if(!_isDisconnected()){var message={channel:"/meta/connect",connectionType:_transport.getType()};if(!_connected){message.advice={timeout:0}}_setStatus("connecting");_cometd._debug("Connect sent",message);_send(false,[message],true,"connect");_setStatus("connected")}}function _delayedConnect(){_setStatus("connecting");_delayedSend(function(){_connect()})}function _updateAdvice(newAdvice){if(newAdvice){_advice=_cometd._mixin(false,{},_config.advice,newAdvice);_cometd._debug("New advice",_advice)}}function _disconnect(abort){_cancelDelayedSend();if(abort){_transport.abort()}_clientId=null;_setStatus("disconnected");_batch=0;_resetBackoff();if(_messageQueue.length>0){_handleFailure.call(_cometd,undefined,_messageQueue,{reason:"Disconnected"});_messageQueue=[]}}function _handshake(handshakeProps){_clientId=null;_clearSubscriptions();if(_isDisconnected()){_transports.reset();_updateAdvice(_config.advice)}else{_updateAdvice(_cometd._mixin(false,_advice,{reconnect:"retry"}))}_batch=0;_internalBatch=true;_handshakeProps=handshakeProps;var version="1.0";var url=_cometd.getURL();var transportTypes=_transports.findTransportTypes(version,_crossDomain,url);var bayeuxMessage={version:version,minimumVersion:"0.9",channel:"/meta/handshake",supportedConnectionTypes:transportTypes,advice:{timeout:_advice.timeout,interval:_advice.interval}};var message=_cometd._mixin(false,{},_handshakeProps,bayeuxMessage);_transport=_transports.negotiateTransport(transportTypes,version,_crossDomain,url);if(!_transport){var error="Could not find initial transport among: "+_transports.getTransportTypes();_cometd._warn(error);throw error}_cometd._debug("Initial transport is",_transport.getType());_setStatus("handshaking");_cometd._debug("Handshake sent",message);_send(false,[message],false,"handshake")}function _delayedHandshake(){_setStatus("handshaking");_internalBatch=true;_delayedSend(function(){_handshake(_handshakeProps)})}function _failHandshake(message){_notifyListeners("/meta/handshake",message);_notifyListeners("/meta/unsuccessful",message);var retry=!_isDisconnected()&&_advice.reconnect!=="none";if(retry){_increaseBackoff();_delayedHandshake()}else{_disconnect(false)}}function _handshakeResponse(message){if(message.successful){_clientId=message.clientId;var url=_cometd.getURL();var newTransport=_transports.negotiateTransport(message.supportedConnectionTypes,message.version,_crossDomain,url);if(newTransport===null){throw"Could not negotiate transport with server; client "+_transports.findTransportTypes(message.version,_crossDomain,url)+", server "+message.supportedConnectionTypes}else{if(_transport!==newTransport){_cometd._debug("Transport",_transport,"->",newTransport);_transport=newTransport}}_internalBatch=false;_flushBatch();message.reestablish=_reestablish;_reestablish=true;_notifyListeners("/meta/handshake",message);var action=_isDisconnected()?"none":_advice.reconnect;switch(action){case"retry":_resetBackoff();_delayedConnect();break;case"none":_disconnect(false);break;default:throw"Unrecognized advice action "+action}}else{_failHandshake(message)}}function _handshakeFailure(message){_failHandshake(message)}function _failConnect(message){_notifyListeners("/meta/connect",message);_notifyListeners("/meta/unsuccessful",message);var action=_isDisconnected()?"none":_advice.reconnect;switch(action){case"retry":_delayedConnect();_increaseBackoff();break;case"handshake":_transports.reset();_resetBackoff();_delayedHandshake();break;case"none":_disconnect(false);break;default:throw"Unrecognized advice action"+action}}function _connectResponse(message){_connected=message.successful;if(_connected){_notifyListeners("/meta/connect",message);var action=_isDisconnected()?"none":_advice.reconnect;switch(action){case"retry":_resetBackoff();_delayedConnect();break;case"none":_disconnect(false);break;default:throw"Unrecognized advice action "+action}}else{_failConnect(message)}}function _connectFailure(message){_connected=false;_failConnect(message)}function _failDisconnect(message){_disconnect(true);_notifyListeners("/meta/disconnect",message);_notifyListeners("/meta/unsuccessful",message)}function _disconnectResponse(message){if(message.successful){_disconnect(false);_notifyListeners("/meta/disconnect",message)}else{_failDisconnect(message)}}function _disconnectFailure(message){_failDisconnect(message)}function _failSubscribe(message){var subscriptions=_listeners[message.subscription];if(subscriptions){for(var i=subscriptions.length-1;i>=0;--i){var subscription=subscriptions[i];if(subscription&&!subscription.listener){delete subscriptions[i];_cometd._debug("Removed failed subscription",subscription);break}}}_notifyListeners("/meta/subscribe",message);_notifyListeners("/meta/unsuccessful",message)}function _subscribeResponse(message){if(message.successful){_notifyListeners("/meta/subscribe",message)}else{_failSubscribe(message)}}function _subscribeFailure(message){_failSubscribe(message)}function _failUnsubscribe(message){_notifyListeners("/meta/unsubscribe",message);_notifyListeners("/meta/unsuccessful",message)}function _unsubscribeResponse(message){if(message.successful){_notifyListeners("/meta/unsubscribe",message)}else{_failUnsubscribe(message)}}function _unsubscribeFailure(message){_failUnsubscribe(message)}function _handlePublishCallback(message){var callback=_publishCallbacks[message.id];if(_isFunction(callback)){delete _publishCallbacks[message.id];callback.call(_cometd,message)}}function _failMessage(message){_handlePublishCallback(message);_notifyListeners("/meta/publish",message);_notifyListeners("/meta/unsuccessful",message)}function _messageResponse(message){if(message.successful===undefined){if(message.data!==undefined){_notifyListeners(message.channel,message)}else{_cometd._warn("Unknown Bayeux Message",message)}}else{if(message.successful){_handlePublishCallback(message);_notifyListeners("/meta/publish",message)}else{_failMessage(message)}}}function _messageFailure(failure){_failMessage(failure)}function _receive(message){message=_applyIncomingExtensions(message);if(message===undefined||message===null){return}_updateAdvice(message.advice);var channel=message.channel;switch(channel){case"/meta/handshake":_handshakeResponse(message);break;case"/meta/connect":_connectResponse(message);break;case"/meta/disconnect":_disconnectResponse(message);break;case"/meta/subscribe":_subscribeResponse(message);break;case"/meta/unsubscribe":_unsubscribeResponse(message);break;default:_messageResponse(message);break}}this.receive=_receive;_handleMessages=function(rcvdMessages){_cometd._debug("Received",rcvdMessages);for(var i=0;i<rcvdMessages.length;++i){var message=rcvdMessages[i];_receive(message)}};_handleFailure=function(conduit,messages,failure){_cometd._debug("handleFailure",conduit,messages,failure);failure.transport=conduit;for(var i=0;i<messages.length;++i){var message=messages[i];var failureMessage={successful:false,channel:message.channel,failure:failure};failure.message=message;switch(message.channel){case"/meta/handshake":failureMessage.id=message.id;_handshakeFailure(failureMessage);break;case"/meta/connect":failureMessage.id=message.id;_connectFailure(failureMessage);break;case"/meta/disconnect":failureMessage.id=message.id;_disconnectFailure(failureMessage);break;case"/meta/subscribe":failureMessage.id=message.id;failureMessage.subscription=message.subscription;_subscribeFailure(failureMessage);break;case"/meta/unsubscribe":failureMessage.id=message.id;failureMessage.subscription=message.subscription;_unsubscribeFailure(failureMessage);break;default:_messageFailure(failureMessage);break}}};function _hasSubscriptions(channel){var subscriptions=_listeners[channel];if(subscriptions){for(var i=0;i<subscriptions.length;++i){if(subscriptions[i]){return true}}}return false}function _resolveScopedCallback(scope,callback){var delegate={scope:scope,method:callback};if(_isFunction(scope)){delegate.scope=undefined;delegate.method=scope}else{if(_isString(callback)){if(!scope){throw"Invalid scope "+scope}delegate.method=scope[callback];if(!_isFunction(delegate.method)){throw"Invalid callback "+callback+" for scope "+scope}}else{if(!_isFunction(callback)){throw"Invalid callback "+callback}}}return delegate}function _addListener(channel,scope,callback,isListener){var delegate=_resolveScopedCallback(scope,callback);_cometd._debug("Adding",isListener?"listener":"subscription","on",channel,"with scope",delegate.scope,"and callback",delegate.method);var subscription={channel:channel,scope:delegate.scope,callback:delegate.method,listener:isListener};var subscriptions=_listeners[channel];if(!subscriptions){subscriptions=[];_listeners[channel]=subscriptions}subscription.id=subscriptions.push(subscription)-1;_cometd._debug("Added",isListener?"listener":"subscription",subscription);subscription[0]=channel;subscription[1]=subscription.id;return subscription}this.registerTransport=function(type,transport,index){var result=_transports.add(type,transport,index);if(result){this._debug("Registered transport",type);if(_isFunction(transport.registered)){transport.registered(type,this)}}return result};this.getTransportTypes=function(){return _transports.getTransportTypes()};this.unregisterTransport=function(type){var transport=_transports.remove(type);if(transport!==null){this._debug("Unregistered transport",type);if(_isFunction(transport.unregistered)){transport.unregistered()}}return transport};this.unregisterTransports=function(){_transports.clear()};this.findTransport=function(name){return _transports.find(name)};this.configure=function(configuration){_configure.call(this,configuration)};this.init=function(configuration,handshakeProps){this.configure(configuration);this.handshake(handshakeProps)};this.handshake=function(handshakeProps){_setStatus("disconnected");_reestablish=false;_handshake(handshakeProps)};this.disconnect=function(sync,disconnectProps){if(_isDisconnected()){return}if(disconnectProps===undefined){if(typeof sync!=="boolean"){disconnectProps=sync;sync=false}}var bayeuxMessage={channel:"/meta/disconnect"};var message=this._mixin(false,{},disconnectProps,bayeuxMessage);_setStatus("disconnecting");_send(sync===true,[message],false,"disconnect")};this.startBatch=function(){_startBatch()};this.endBatch=function(){_endBatch()};this.batch=function(scope,callback){var delegate=_resolveScopedCallback(scope,callback);this.startBatch();try{delegate.method.call(delegate.scope);this.endBatch()}catch(x){this._info("Exception during execution of batch",x);this.endBatch();throw x}};this.addListener=function(channel,scope,callback){if(arguments.length<2){throw"Illegal arguments number: required 2, got "+arguments.length}if(!_isString(channel)){throw"Illegal argument type: channel must be a string"}return _addListener(channel,scope,callback,true)};this.removeListener=function(subscription){if(!subscription||!subscription.channel||!("id" in subscription)){throw"Invalid argument: expected subscription, not "+subscription}_removeListener(subscription)};this.clearListeners=function(){_listeners={}};this.subscribe=function(channel,scope,callback,subscribeProps){if(arguments.length<2){throw"Illegal arguments number: required 2, got "+arguments.length}if(!_isString(channel)){throw"Illegal argument type: channel must be a string"}if(_isDisconnected()){throw"Illegal state: already disconnected"}if(_isFunction(scope)){subscribeProps=callback;callback=scope;scope=undefined}var send=!_hasSubscriptions(channel);var subscription=_addListener(channel,scope,callback,false);if(send){var bayeuxMessage={channel:"/meta/subscribe",subscription:channel};var message=this._mixin(false,{},subscribeProps,bayeuxMessage);_queueSend(message)}return subscription};this.unsubscribe=function(subscription,unsubscribeProps){if(arguments.length<1){throw"Illegal arguments number: required 1, got "+arguments.length}if(_isDisconnected()){throw"Illegal state: already disconnected"}this.removeListener(subscription);var channel=subscription.channel;if(!_hasSubscriptions(channel)){var bayeuxMessage={channel:"/meta/unsubscribe",subscription:channel};var message=this._mixin(false,{},unsubscribeProps,bayeuxMessage);_queueSend(message)}};this.resubscribe=function(subscription,subscribeProps){_removeSubscription(subscription);if(subscription){return this.subscribe(subscription.channel,subscription.scope,subscription.callback,subscribeProps)}return undefined};this.clearSubscriptions=function(){_clearSubscriptions()};this.publish=function(channel,content,publishProps,publishCallback){if(arguments.length<1){throw"Illegal arguments number: required 1, got "+arguments.length}if(!_isString(channel)){throw"Illegal argument type: channel must be a string"}if(/^\/meta\//.test(channel)){throw"Illegal argument: cannot publish to meta channels"}if(_isDisconnected()){throw"Illegal state: already disconnected"}if(_isFunction(content)){publishCallback=content;content=publishProps={}}else{if(_isFunction(publishProps)){publishCallback=publishProps;publishProps={}}}var bayeuxMessage={channel:channel,data:content,_callback:publishCallback};var message=this._mixin(false,{},publishProps,bayeuxMessage);_queueSend(message)};this.getStatus=function(){return _status};this.isDisconnected=_isDisconnected;this.setBackoffIncrement=function(period){_config.backoffIncrement=period};this.getBackoffIncrement=function(){return _config.backoffIncrement};this.getBackoffPeriod=function(){return _backoff};this.setLogLevel=function(level){_config.logLevel=level};this.registerExtension=function(name,extension){if(arguments.length<2){throw"Illegal arguments number: required 2, got "+arguments.length}if(!_isString(name)){throw"Illegal argument type: extension name must be a string"}var existing=false;for(var i=0;i<_extensions.length;++i){var existingExtension=_extensions[i];if(existingExtension.name===name){existing=true;break}}if(!existing){_extensions.push({name:name,extension:extension});this._debug("Registered extension",name);if(_isFunction(extension.registered)){extension.registered(name,this)}return true}else{this._info("Could not register extension with name",name,"since another extension with the same name already exists");return false}};this.unregisterExtension=function(name){if(!_isString(name)){throw"Illegal argument type: extension name must be a string"}var unregistered=false;for(var i=0;i<_extensions.length;++i){var extension=_extensions[i];if(extension.name===name){_extensions.splice(i,1);unregistered=true;this._debug("Unregistered extension",name);var ext=extension.extension;if(_isFunction(ext.unregistered)){ext.unregistered()}break}}return unregistered};this.getExtension=function(name){for(var i=0;i<_extensions.length;++i){var extension=_extensions[i];if(extension.name===name){return extension.extension}}return null};this.getName=function(){return _name};this.getClientId=function(){return _clientId};this.getURL=function(){if(_transport&&typeof _config.urls==="object"){var url=_config.urls[_transport.getType()];if(url){return url}}return _config.url};this.getTransport=function(){return _transport};this.getConfiguration=function(){return this._mixin(true,{},_config)};this.getAdvice=function(){return this._mixin(true,{},_advice)};org.cometd.WebSocket=window.WebSocket;if(!org.cometd.WebSocket){org.cometd.WebSocket=window.MozWebSocket}};